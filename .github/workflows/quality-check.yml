name: Training Material Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run monthly to check for broken links
    - cron: '0 0 1 * *'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: 'node_modules'

  link-checker:
    name: Check External Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links in markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.markdown-link-check.json'

  spell-check:
    name: Spelling Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check spelling
        uses: rojopolis/spellcheck-github-actions@0.36.0
        with:
          config_path: .spellcheck.yml
          task_name: Markdown

  opm-regulation-check:
    name: OPM Regulation Currency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 pyyaml

      - name: Check OPM regulations are current
        run: |
          python scripts/check_opm_currency.py

  content-quality:
    name: Content Quality Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check module completeness
        run: |
          python scripts/check_module_completeness.py

      - name: Validate curriculum structure
        run: |
          python scripts/validate_curriculum.py

  accessibility-check:
    name: Accessibility Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Section 508 compliance
        run: |
          python scripts/check_accessibility.py

  generate-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-checker, spell-check, content-quality]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate quality report
        run: |
          python scripts/generate_quality_report.py

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: reports/quality-report.html
          retention-days: 30

  auto-label:
    name: Auto-label Issues and PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'issues'
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml

  comment-on-pr:
    name: Comment Quality Metrics on PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    needs: [markdown-lint, content-quality]
    steps:
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ## üìä Training Material Quality Check

            Thank you for your contribution! Here's the quality assessment:

            - ‚úÖ Markdown formatting
            - ‚úÖ Content structure validation
            - ‚è≥ OPM regulation currency check in progress

            Please ensure:
            1. All OPM references are current (2025-2026)
            2. Module learning objectives are clearly defined
            3. Assessment criteria are included
            4. Resources are properly cited

            For detailed results, see the workflow artifacts.
