name: OPM Update Monitor

on:
  schedule:
    # Check daily at 9 AM UTC (4 AM EST)
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-opm-updates:
    name: Monitor OPM.gov for Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 feedparser pyyaml

      - name: Check Federal Register for HR updates
        run: |
          python scripts/monitor_federal_register.py

      - name: Check OPM Benefits Officers Center
        run: |
          python scripts/monitor_opm_benefits.py

      - name: Check OPM Policy Data Oversight
        run: |
          python scripts/monitor_opm_policy.py

      - name: Generate update report
        id: update_report
        run: |
          python scripts/generate_opm_update_report.py > opm_updates.md
          if [ -s opm_updates.md ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Store update date
        if: steps.update_report.outputs.has_updates == 'true'
        run: |
          echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Create issue for updates
        if: steps.update_report.outputs.has_updates == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'OPM Update Detected - Curriculum Review Required'
          content-filepath: ./opm_updates.md
          labels: |
            opm-update
            needs-review
            documentation

      - name: Create Pull Request for updates
        if: steps.update_report.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: OPM update detected on ${{ env.DATE }}"
          branch: automated/opm-updates-${{ env.DATE }}
          delete-branch: true
          title: 'OPM Update Detected - Curriculum Review Required'
          body: |
            ## Automated OPM Update Detection

            This PR was automatically generated by the OPM Update Monitor workflow.

            **Detected Changes:**
            See `opm-updates/${{ env.DATE }}/update-${{ env.DATE }}.md` for details.

            **Action Required:**
            - Review the detected changes
            - Update relevant training modules
            - Verify compliance with current OPM regulations
            - Merge this PR after review

            Related issue will be created automatically.
          labels: |
            opm-update
            automated
            needs-review
          draft: true
          add-paths: |
            opm-updates/**/*.md

  check-cfr-changes:
    name: Monitor 5 CFR Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Check eCFR for Title 5 updates
        id: cfr_check
        run: |
          python scripts/monitor_5cfr.py
          if [ -f cfr_updates.md ] && [ -s cfr_updates.md ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if CFR changed
        if: steps.cfr_check.outputs.has_updates == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: '5 CFR Regulation Update - Training Material Review Required'
          content-filepath: ./cfr_updates.md
          labels: |
            cfr-update
            needs-review
            compliance
